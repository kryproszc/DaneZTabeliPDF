library(leaflet)
library(htmlwidgets)
library(webshot)
library(officer)
library(magrittr)
library(png)
library(grid)

# Tworzenie nowego dokumentu Word
doc <- read_docx()

# Zakładam, że masz listę dataframe'ów lub inny sposób na generowanie danych do map
for (i in 1:n) {
  # Tworzenie mapy (przykład dla każdej iteracji)
  map <- leaflet(jednostki_data[[i]]) %>%
    addTiles() %>%
    setView(lng = 19.1451, lat = 51.9194, zoom = 6) %>%
    addPolygons(fillColor = ~ifelse(Value == 0, "transparent", pal(Value)), color = "#BDBDC3", weight = 1,
                fillOpacity = 0.7, smoothFactor = 0.5,
                popup = ~paste(JPT_NAZWA_, "<br>", "dddd", ": ", Value)) %>%
    addLegend(pal = pal, values = ~Value, opacity = 0.7, title = "Skala", position = "bottomright")
  
  # Zapisz mapę jako tymczasowy plik HTML
  html_file <- tempfile(fileext = ".html")
  saveWidget(map, file = html_file, selfcontained = TRUE)
  
  # Zapisz mapę jako obrazek PNG w pamięci
  png_file <- tempfile(fileext = ".png")
  webshot(html_file, file = png_file, cliprect = "viewport", vwidth = 800, vheight = 600)

  # Odczytaj obrazek PNG z pliku do obiektu R
  img <- readPNG(png_file)
  
  # Utwórz rasterGrob z obrazka
  img_grob <- rasterGrob(img, interpolate = TRUE)

  # Dodanie mapy do dokumentu Word jako obraz
  doc <- doc %>% 
    body_add_par(paste("Mapa jednostek", i), style = "heading 1") %>%
    body_add_img(src = png_file, width = 6, height = 4, style = "centered")

  # Usunięcie tymczasowych plików
  unlink(html_file)
  unlink(png_file)
}

# Zapisanie dokumentu Word
print(doc, target = "wszystkie_mapy.docx")
