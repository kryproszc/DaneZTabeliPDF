library(ggplot2)
library(sf)
library(dplyr)

# Wczytanie granic Polski z pliku SHP (upewnij się, że podajesz właściwą ścieżkę do pliku)
polska <- st_read("gminy/gminy.shp")  # Podaj poprawną ścieżkę do pliku SHP z granicami gmin Polski

# Naprawa geometrii (opcjonalnie, jeśli występują problemy)
polska <- st_buffer(polska, 0)

# Przekształcenie układu współrzędnych granic gmin na WGS 84 (EPSG:4326)
polska <- st_transform(polska, crs = 4326)

# Przykładowa ramka danych zawierająca współrzędne i liczbę budynków w danym kodzie pocztowym
# Tutaj można dodać więcej wierszy z danymi o różnych kodach pocztowych
coordinates <- data.frame(
  latitude = c(52.22985, 50.06143, 51.10789),  # Szerokość geograficzna
  longitude = c(21.00652, 19.93884, 17.03854), # Długość geograficzna
  ilosc = c(20, 35, 50)  # Liczba budynków w danym kodzie pocztowym
)

# Konwersja ramki danych do obiektu przestrzennego (sf)
punkty_sf <- st_as_sf(coordinates, coords = c("longitude", "latitude"), crs = 4326)

# Lista do przechowywania gmin zawierających podane współrzędne
znalezione_gminy <- list()

# Iterowanie przez każdy punkt i znajdowanie gminy, która go zawiera
for (i in 1:nrow(punkty_sf)) {
  punkt <- punkty_sf[i, ]
  gmina <- polska[st_contains(polska, punkt, sparse = FALSE), ]
  
  if (nrow(gmina) > 0) {
    gmina$ilosc <- coordinates$ilosc[i]  # Dodajemy informację o liczbie budynków do gminy
    znalezione_gminy[[i]] <- gmina  # Przechowujemy gminę w liście
  }
}

# Połączenie wszystkich znalezionych gmin w jedną ramkę danych
wszystkie_gminy_sf <- do.call(rbind, znalezione_gminy)

# Rysowanie mapy Polski z zaznaczeniem wszystkich gmin i punktów
ggplot() +
  geom_sf(data = polska, fill = "lightgray", color = "black") +  # Rysowanie wszystkich granic gmin
  geom_sf(data = wszystkie_gminy_sf, aes(fill = ilosc), color = "black", size = 0.5) +  # Zaznaczenie znalezionych gmin, wypełnienie według liczby budynków
  geom_sf(data = punkty_sf, aes(size = ilosc), color = "red", shape = 21, fill = "yellow", stroke = 1.5) +  # Zaznaczenie punktów z liczbą budynków
  scale_fill_gradient(low = "lightyellow", high = "red", name = "Liczba budynków") +  # Gradient kolorów dla liczby budynków
  scale_size_continuous(range = c(3, 10), name = "Liczba budynków") +  # Skala wielkości punktów według liczby budynków
  theme_minimal() +
  labs(title = "Zaznaczenie gmin na mapie Polski na podstawie współrzędnych",
       subtitle = "Kolor i wielkość zależne od liczby budynków") +
  coord_sf()
