library(ggplot2)
library(sf)
library(dplyr)

# Wczytanie granic Polski z pliku SHP (upewnij się, że podajesz właściwą ścieżkę do pliku)
polska <- st_read("gminy/gminy.shp")  # Podaj poprawną ścieżkę do pliku SHP z granicami gmin Polski

# Sprawdzenie, czy dane zostały poprawnie wczytane
print("Struktura wczytanych danych:")
print(st_geometry_type(polska))  # Typy geometrii (np. POLYGON)
print(st_crs(polska))            # Układ współrzędnych (CRS)

# Naprawa geometrii (jeśli są problemy z geometrią)
# Użyj jednej z poniższych opcji:

# 1. Naprawa geometrii przy użyciu st_make_valid (wymaga pakietu lwgeom)
# install.packages("lwgeom")  # Jeśli `lwgeom` nie jest zainstalowany, zainstaluj go
# library(lwgeom)
# polska <- st_make_valid(polska)

# 2. Alternatywnie, użyj st_buffer() z zerową wartością bufora, aby naprawić geometrię
polska <- st_buffer(polska, 0)

# Sprawdzenie poprawności geometrii
if (any(!st_is_valid(polska))) {
  print("Niektóre geometrie są nieprawidłowe. Usuwanie nieprawidłowych geometrii...")
  polska <- polska[st_is_valid(polska), ]  # Usunięcie nieprawidłowych geometrii
}

# Uproszczenie geometrii w celu poprawy wydajności (zmniejsza liczbę wierzchołków)
polska <- st_simplify(polska, dTolerance = 0.001)

# Sprawdzenie liczby geometrii (gmin) po uproszczeniu
print(paste("Liczba geometrii (gmin) po uproszczeniu:", nrow(polska)))

# Wprowadź uzyskane współrzędne punktu (na podstawie zapytania HTTP)
coordinates <- data.frame(
  latitude = 52.22985,  # Wprowadź uzyskaną szerokość geograficzną (np. z zapytania HTTP)
  longitude = 21.00652  # Wprowadź uzyskaną długość geograficzną (np. z zapytania HTTP)
)

# Konwersja ramki danych do obiektu przestrzennego (sf)
punkt_sf <- st_as_sf(coordinates, coords = c("longitude", "latitude"), crs = 4326)  # Ustaw układ współrzędnych na WGS 84

# Przekształcenie układu współrzędnych granic gmin na WGS 84 (EPSG:4326) - jeśli dane mają inny układ
polska <- st_transform(polska, crs = 4326)

# Znalezienie gminy, która zawiera podany punkt
gmina_sf <- polska[st_contains(polska, punkt_sf, sparse = FALSE), ]

# Sprawdzenie, czy gmina została znaleziona
if (nrow(gmina_sf) == 0) {
  stop("Nie znaleziono gminy dla podanych współrzędnych.")
} else {
  print("Znaleziono gminę dla podanych współrzędnych.")
}

# Rysowanie mapy Polski z zaznaczeniem znalezionej gminy
ggplot() +
  geom_sf(data = polska, fill = "lightblue", color = "black") +  # Rysowanie wszystkich granic gmin
  geom_sf(data = gmina_sf, fill = "yellow", color = "black") +  # Zaznaczenie znalezionej gminy innym kolorem
  geom_sf(data = punkt_sf, color = "red", size = 3) +  # Zaznaczenie punktu na mapie (opcjonalnie)
  theme_minimal() +
  labs(title = "Zaznaczenie gminy na mapie Polski na podstawie współrzędnych") +
  coord_sf()
