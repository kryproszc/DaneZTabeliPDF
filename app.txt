polska <- st_read("gminy/gminy.shp")

# Naprawa geometrii
polska <- st_make_valid(polska)  # Naprawia błędne geometrie

# Upewnij się, że CRS dla polska jest w WGS 84
polska <- st_transform(polska, crs = 4326)

# Przykładowe dane współrzędnych
coordinates <- data.frame(
  latitude = c(52.22985, 50.06143, 51.10789),
  longitude = c(21.00652, 19.93884, 17.03854),
  ilosc = c(20, 35, 50)
)

# Konwersja ramki danych do obiektu sf
punkty_sf <- st_as_sf(coordinates, coords = c("longitude", "latitude"), crs = 4326)

# Sprawdzenie CRS dla obu obiektów
print(st_crs(polska))     # Sprawdzenie CRS dla polska
print(st_crs(punkty_sf))  # Sprawdzenie CRS dla punkty_sf

# Lista do przechowywania gmin
znalezione_gminy <- list()

# Iteracja przez każdy punkt
for (i in 1:nrow(punkty_sf)) {
  punkt <- punkty_sf[i, ]
  
  # Upewnij się, że CRS są zgodne
  if (!st_crs(punkt) == st_crs(polska)) {
    punkt <- st_transform(punkt, st_crs(polska))  # Przekształcenie CRS punktu
  }
  
  gmina <- polska[st_contains(polska, punkt, sparse = FALSE), ]
  
  if (nrow(gmina) > 0) {
    gmina$ilosc <- coordinates$ilosc[i]  
    znalezione_gminy[[i]] <- gmina  
  } else {
    warning(paste("Nie znaleziono gminy dla punktu:", punkt))
  }
}

# Połączenie wszystkich znalezionych gmin w jedną ramkę danych
wszystkie_gminy_sf <- do.call(rbind, znalezione_gminy)

# Wyświetlenie wyników
print(wszytkie_gminy_sf)
ggsave("mapa_gminy.png", plot = map, width = 12, height = 8, units = "in", dpi = 300)


# Tworzenie nowego arkusza Excel
wb <- createWorkbook()
addWorksheet(wb, "Ubezpieczyciel")  # Dodanie nowego arkusza

# Zapisanie danych do arkusza (przykładowo, zakładając, że masz dane o gminach)
wszystkie_gminy_df <- st_drop_geometry(wszystkie_gminy_sf)  # Usunięcie geometrii

# Zapisanie danych do arkusza
writeData(wb, sheet = "Ubezpieczyciel", x = wszystkie_gminy_df)

# Dodanie obrazu do arkusza
insertImage(wb, sheet = "Ubezpieczyciel", file = "mapa_gminy.png", startRow = 1, startCol = 6)

# Zapisanie pliku Excel na dysku
saveWorkbook(wb, "gminy_wspolrzedne.xlsx", overwrite = TRUE)


