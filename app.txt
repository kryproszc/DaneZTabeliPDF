for(nazwa_ubezpieczyciela in ubezpieczyciel){
  print(paste0("Wyznaczam ubezpieczyciela: ", nazwa_ubezpieczyciela))
  addWorksheet(wb, nazwa_ubezpieczyciela)
  
  # Ścieżka do folderu danego ubezpieczyciela
  sciezka_ubezpieczyciel <- file.path(sciezka_glowna, nazwa_ubezpieczyciela)
  sciezka_standaryzacja <- file.path(sciezka_ubezpieczyciel, "standaryzacja v3")
  
  # Rekurencyjne przeszukiwanie podfolderów w "standaryzacja v3" w celu znalezienia wszystkich plików CSV
  pliki_csv <- list.files(sciezka_standaryzacja, pattern = "\\.csv$", full.names = TRUE, recursive = TRUE)
  
  # Wyszukanie plików zawierających "Ubezpieczone obiekty" w nazwie
  pliki_do_wczytania <- pliki_csv[grep("Ubezpieczone obiekty", pliki_csv)]
  
  # Jeśli są pliki do wczytania
  if (length(pliki_do_wczytania) > 0) {
    # Tworzenie katalogu do zapisu, jeśli nie istnieje
    sciezka_do_zapisu_ubezpieczyciel <- file.path(sciezka_zapisu, nazwa_ubezpieczyciela)
    if (!dir.exists(sciezka_do_zapisu_ubezpieczyciel)) {
      dir.create(sciezka_do_zapisu_ubezpieczyciel, recursive = TRUE)
    }
    
    # Łączenie wszystkich plików CSV w jeden zbiór danych
    lista_danych <- lapply(pliki_do_wczytania, function(plik) {
      read.csv2(plik, sep = ";", dec = ".")
    })
    
    # Połączenie wszystkich ramek danych w jedną
    data_input <- do.call(rbind, lista_danych)
    
    # Wykonanie analizy na połączonym zbiorze danych
    input_data <- as.data.frame(table(data_input$Adres.ubezpieczonego.obiektu...Kod.pocztowy))
    colnames(input_data) <- c("kody", "ilosc")
    
    # Obliczenie prawdopodobieństwa
    sum_ilosc <- sum(input_data$ilosc)
    input_data$prawdopodobienstwo <- input_data$ilosc / sum_ilosc
    
    # Zapis wyników do arkusza
    writeData(wb, sheet = nazwa_ubezpieczyciela, input_data, startCol = 1, startRow = 1, colNames = TRUE)
    
    # Zapis połączonego CSV do folderu ubezpieczyciela
    write.csv2(input_data, file = file.path(sciezka_do_zapisu_ubezpieczyciel, paste0(nazwa_ubezpieczyciela, "_combined.csv")), row.names = FALSE)
    
    # Dalsze analizy...
    
  } else {
    print(paste0("Brak danych o ubezpieczonych budynkach dla ubezpieczyciela ", nazwa_ubezpieczyciela))
  }
}
