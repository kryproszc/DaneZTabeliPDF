
# Załaduj pakiety
library(sf)
library(ggplot2)
library(dplyr)
library(lwgeom)
library(openxlsx)

# Wczytanie granic Polski z pliku SHP
polska <- st_read("gminy/gminy.shp")

# Naprawa geometrii gmin
polska <- st_make_valid(polska)

# Upewnij się, że CRS dla polska jest w WGS 84
polska <- st_transform(polska, crs = 4326)

# Przykładowe dane współrzędnych
coordinates <- data.frame(
  latitude = c(52.22985, 50.06143, 51.10789),
  longitude = c(21.00652, 19.93884, 17.03854),
  ilosc = c(20, 35, 50)
)

# Konwersja ramki danych do obiektu sf
punkty_sf <- st_as_sf(coordinates, coords = c("longitude", "latitude"), crs = 4326)

# Sprawdzenie CRS dla obu obiektów
print(st_crs(polska))
print(st_crs(punkty_sf))

# Lista do przechowywania gmin
znalezione_gminy <- list()

# Iteracja przez każdy punkt
for (i in 1:nrow(punkty_sf)) {
  punkt <- punkty_sf[i, ]
  punkt <- st_transform(punkt, st_crs(polska))
  gmina <- polska[st_contains(polska, punkt, sparse = FALSE), ]
  
  if (nrow(gmina) > 0) {
    gmina$ilosc <- coordinates$ilosc[i]  
    znalezione_gminy[[i]] <- gmina  
  }
}

# Połączenie wszystkich znalezionych gmin w jedną ramkę danych
wszystkie_gminy_sf <- do.call(rbind, znalezione_gminy)

# Rysowanie mapy Polski
map <- ggplot() +
  geom_sf(data = polska, fill = "lightgray", color = "black") +  
  geom_sf(data = wszystkie_gminy_sf, aes(fill = ilosc), color = "black", size = 0.5) +  
  scale_fill_gradient(low = "lightyellow", high = "red", name = "Liczba budynków") +  
  theme_minimal() +
  labs(title = "Zaznaczenie gmin na mapie Polski na podstawie współrzędnych",
       subtitle = "Kolor zależny od liczby budynków") +
  coord_sf()

# Zapisanie mapy do pliku PNG
ggsave("mapa_gminy.png", plot = map, width = 12, height = 8, units = "in", dpi = 300)

# Tworzenie nowego arkusza Excel
wb <- createWorkbook()
addWorksheet(wb, "Ubezpieczyciel")

# Konwersja ramki danych do formatu tabelarycznego (bez geometrii)
wszystkie_gminy_df <- st_drop_geometry(wszystkie_gminy_sf)

# Zapisanie danych do arkusza
writeData(wb, sheet = "Ubezpieczyciel", x = wszystkie_gminy_df)

# Dodanie obrazu do arkusza
insertImage(wb, sheet = "Ubezpieczyciel", file = "mapa_gminy.png", startRow = 1, startCol = 6)

# Zapisanie pliku Excel na dysku
saveWorkbook(wb, "gminy_wspolrzedne.xlsx", overwrite = TRUE)

print("Dane o gminach oraz mapa zostały zapisane do pliku Excel w zakładce 'Ubezpieczyciel'.")
