library(httr)
library(jsonlite)

# Funkcja przyjmująca ramkę danych z kodami pocztowymi i liczbą budynków
get_coordinates_by_postcodes <- function(data) {
  # Sprawdzenie, czy wejściowa ramka danych zawiera wymagane kolumny
  if (!all(c("kody", "ilosc") %in% colnames(data))) {
    stop("Wejściowa ramka danych musi zawierać kolumny 'kody' i 'ilosc'.")
  }
  
  # Inicjalizacja pustej ramki danych do przechowywania wyników
  results <- data.frame(latitude = numeric(0), longitude = numeric(0), ilosc = numeric(0))
  
  # Iteracja przez każdy wiersz ramki danych
  for (i in 1:nrow(data)) {
    postcode <- data$kody[i]
    ilosc <- data$ilosc[i]
    
    # Definiowanie URL serwera
    url <- "http://dft-everace:8080/search.php"
    
    # Przygotowanie zapytania z kodem pocztowym jako parametrem
    params <- list(q = URLencode(postcode))
    
    # Wysłanie zapytania HTTP GET do serwera
    response <- GET(url, query = params)
    
    # Sprawdzenie, czy odpowiedź jest prawidłowa (kod odpowiedzi 200)
    if (status_code(response) == 200) {
      # Pobranie treści odpowiedzi jako tekst
      content_text <- content(response, "text", encoding = "UTF-8")
      
      # Parsowanie odpowiedzi jako JSON
      response_json <- fromJSON(content_text, flatten = TRUE)
      
      # Tworzenie ramki danych z koordynatami i ilością
      result_row <- data.frame(
        latitude = response_json$lat,
        longitude = response_json$lon,
        ilosc = ilosc
      )
      
      # Dodanie wiersza do wynikowej ramki
      results <- rbind(results, result_row)
    } else {
      warning(paste("Błąd podczas zapytania dla kodu:", postcode, " - Kod odpowiedzi:", status_code(response)))
    }
  }
  
  return(results)
}
